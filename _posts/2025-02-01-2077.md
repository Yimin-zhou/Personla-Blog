---
layout: post
title: 赛博朋克2077—让夜之城有光
description: >-
  总结一篇2077在GDC的分享
image: '/assets/img/2077share/93f3b8c4102964ea6b1d9f7ce795659a.png'
category: 场景
---

## **简介：**

该分享主要介绍，赛博朋克2077如何决定灯光管线以及相关技术的。因为夜之城庞大的体量，为了得到可预见、可靠的灯光，团队决定使用物理正确的灯光管线。物理正确的灯光管线(参考真实世界的自然光和人造光)可以提供一个坚实的基础/稳定的保险。（演讲还包含了光追部分，这里我跳过了）![](/assets/img/2077share/93f3b8c4102964ea6b1d9f7ce795659a.png)


## **光照管线要点：**

1. 光源要基于物理正确的参数(Lux/Lm)。
2. 遵守PBR的材质。
3. 全动态光源。

## **打光：**

**什么是赛博朋克风格？**高度发展的技术和低生活水平产生强烈对比，在视觉上也能反应这种对比（如一名建筑工人为了更好地劳作装上了义肢）。

**电影灯光参考：**
- 视觉上的对比要清晰可见（可见的亮度分层，一个基于故事的主要颜色渐变，欠曝光风格）。
- 视觉的复杂度要支持故事。
- 视觉噪点要控制得不能影响前两点（饱和但是数量较少的颜色，细节分组）。
![](/assets/img/2077share/2061f4313b2100fa484a9b9cc74456a0.png)![](/assets/img/2077share/589f8cac81ceaa1b84912b19bb29dff3.png)![](/assets/img/2077share/a8ed211d1b3439adb8aa98a2aa841fe7.png)

### **1. 基础风格**
- 赛博朋克2077会用少量的灯光打出画面中不同的层次，一个清晰可见的颜色渐变，强制作为当前画面基调。以此可以在后期迭代的时候减少视觉噪点。（下方是引擎中Debug视图（全场景替换半灰非金属材质），类似UE中的光照视图）![](/assets/img/2077share/64c7e07027c4adb55c3c57ef89273b99.png)
- 欠曝在赛博朋克风格中看起来很好看，但是在游戏中会影响游戏性。所以在很多场景必须要让亮度平一点（为了游戏性考虑）。![](/assets/img/2077share/7fcf32023cdb7141d61deacfe2af4b16.png)
- 赛博朋克2077杂糅了大量写实和夸张的风格，同时游戏希望有电影感，于是使用了电影级的后期调色LUT。在Nuke中分别制作HDR显示器和SDR LUT。

| ![](/assets/img/2077share/1679b03ba98cb278eddade53023dadeb.png) | ![](/assets/img/2077share/07479843365dc3a5b3e9959c240d88c9.png) | ![](/assets/img/2077share/e57cf633b01507f199dfeb0ece81bed6.png) |
| ------------------------------------ | ------------------------------------ | ------------------------------------ |
| ![](/assets/img/2077share/7413f6b74c0d3456c0cb2841ff6f0249.png) | ![](/assets/img/2077share/954c7255b8b8e703cd8ac36948eb09e5.png) | ![](/assets/img/2077share/890238186988e37edf0fcd02315b7333.png) |

### 2. 动态24H光照循环。
- 在添加人造光之前，会用太阳/月亮光，天光，作为基调。
- 用真实世界的值作为基础。但白天的太阳光会暗很多，晚上的月光天光会亮很多。
- 晚上使用真实天光可能太黑了，对游戏性有影响，如果在晚上的时候调节曝光，可能导致其他人造灯光过亮，所以提亮晚上的亮度。
- 白天的太阳光比真实世界减少了100倍，使其在自动曝光下不会过曝（100倍是一个比较平衡的值）。
- 因为在游戏中24H被压缩到了3H，最美的日出和日落时间就很少。所以赛博朋克2077人为 增加了一天中日出日落的占比。![](/assets/img/2077share/37e4050ada286e4c548b547671e99daa.png)![](/assets/img/2077share/f5d0825a081a0afbcc39dbac4e5eac17.png)![](/assets/img/2077share/c07ff2d7a5a4300166c37bccdcd769d2.png)

### 3. 全局光照
- 带遮蔽的天光。
- 放置到各处的可流送Probe，可以动态地捕捉从几何体反射的光亮，已经天空的可见性和能量。同时Probe之间的几何体可见性数据（提前撒好的Surfels）也被使用来放置漏光。![](/assets/img/2077share/06e4522c13d5508b5adfb85172e4c3b0.png)
- 全局光照系统只会计算离角色128-192米 之内的灯光。超过这个距离会使用Distant GI。远距离的GI使用反射/阴影贴图，这是一张从上而下的贴图，包含了漫反射和阴影信息，粗略预估环境灯光。这个贴图会每帧重新计算。![](/assets/img/2077share/ba2d645354dc6433e1c5e1e99ff0301f.png)![](/assets/img/2077share/fe556ff88762e248e1c06599bdde6fef.png)
- 反射Probe按照不同的层级摆放，从大到下（放置在半空的大范围->街区级别中范围->街道房间级别小范围）。

### 4. 验证灯光
- 参考真实世界打的自然光，和MAYA的离线渲染进行一比一对比（在UE中可以进行Lumen/烘焙对比）。![](/assets/img/2077share/0c8b016b23de7b4935e75afc37d63262.png)

### 5. 局部灯光
- 路灯作为开放世界中最重要的一层灯光，参考了真实世界的流明值色温值。![](/assets/img/2077share/6f15053b5f89d2eccf20acacce725756.png)
- 赛博朋克中还有很多面光，管状光源。赛博朋克用的是一种胶囊体光源（类似spotlight）。对于方形的广告牌，就用一个范围较大的胶囊体光源。（在UE中可以用光源长度和半径，但只会影响反射）![](/assets/img/2077share/0e64d36bf1596439817bdeb876d9a75a.png)![](/assets/img/2077share/debcc6c5e31cf2c8784504e1252d2f76.png)![](/assets/img/2077share/e437dd3161659c89b40ecba8d2d01c4d.png)
- 体积雾是营造氛围非常重要的一部分，同时也可用在空中制造颜色渐变，较少视觉噪点，增加层次。![](/assets/img/2077share/797100be03262a1cb9c9f2f1ab62f3bf.png)
- 游戏中的Probe对于从窗外到室内的光照反射不好，不支持高光反射。赛博朋克使用了一个叫portal light的东西，相当于是一个从室外照进室内的补光，会根据大气变化角度和颜色(夜间无效)。(UE中不涉及天气变化的话可以直接补光，或者使用light portal)，同时也可以减少窗外的过曝现象。![](/assets/img/2077share/5bbead812cff69e40a8ab06761674fcf.png)![](/assets/img/2077share/a765c067a6d654c29f132b6967f3cca2.png)![](/assets/img/2077share/2d65daa4fc11037682c860a6787c9459.png)
- 为了更接近电影级的控制，（估计在过场动画中）有仅角色补光，也会开启仅角色的contact shadow。![](/assets/img/2077share/927fac678c99503b7cab8c0a876c00bb.png)

### 6.  灯光优化
- 大角度，大范围的灯光会造成更多的阴影压力，在灯的边缘阴影就很不明显了。
    - 赛博朋克2077将灯的范围和生成阴影的范围分开了，阴影范围可以比灯光照范围小。![](/assets/img/2077share/e6a10024d53fba7e64b86abf351128f5.png)
    - 在某些临近的光源可以把阴影范围调小，这样也不会有太明显的瑕疵。![](/assets/img/2077share/eafcb3af110be8ef450293d9df68e868.png)
- 当灯光密度太大，对性能的影响也非常明显。
	- 当有好几排灯光的时候，可以将那些灯光设置为仅体积雾灯光（衰减距离小，不照射到任何物体上），然后用极少量的灯光来打光。这样也可以减少产生阴影的灯光。赛博朋克有8个光照通道体积，这种在室内使用光照通道volume的灯光一般不会生成阴影。![](/assets/img/2077share/f78a74cdcae33592741b6da2efdb919d.png)![](/assets/img/2077share/ce3bbf994f4c66881f114299d4a3b45d.png)![](/assets/img/2077share/48a1a70f58fbfdec9494fd51b6f63ffb.png)
- 阴影淡出淡入，UE好像没有这个功能。![](/assets/img/2077share/097755c59d5c4c4fa2041f0f3694e732.png)
- 在比较高的建筑，不常被光照到的地方可以用cached的静态阴影。![](/assets/img/2077share/3c0ecb8682c8a7f789fdff18c8240575.png)
- 超远距离灯光，在大型城市中，远距离通常会在屏幕中有大量的灯光。赛博朋克的做法是将远距离的灯光替换成distant light（只有漫反射），不参与流送，而是一直保持加载状态。在远距离用体积雾实现光污染开销非常大，于是在远距离用plane particle制造这种光污染的效果（同时也可以用不同的颜色作为区域指示）。![](/assets/img/2077share/c474b3d57a79c512ed5b144400a92019.png)![](/assets/img/2077share/e9b6f167205a4314c8ec0de9a7c08ffb.png)

## **结尾QA：**
1. 你们也会修改UE来实现上面的效果吗？（当时CDPR刚宣布全面转向UE）。
    1. 偏题了不想回答。开发经验不只局限于一个引擎内。
2. 是否使用的ligthmap。
    1. 没有烘焙任何光照贴图。因为所有东西都是动态的，光照贴图烘焙的话会非常非常的大。GI Probe已经够大了。